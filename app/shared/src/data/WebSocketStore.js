Ext.define('Fin.data.WebSocketStore', {
    extend: 'Ext.Mixin',

    // flag set to true when the websocket is open
    _wsIsOpen: false,

    config: {
        // the symbol to subscribe for
        symbol: ''
    },

    // function used to transform the data returned in each message
    webSocketRecordTransform: Ext.identityFn,

    initWebSocket: function() {
        this.socket = new WebSocket('wss://ws.finnhub.io?token=' + Ext._finnhubApiKey);

        // listen for `open` event
        this.socket.addEventListener('open', Ext.bind(this.onWebSocketOpen, this));

        // Listen for messages
        this.socket.addEventListener('message', Ext.bind(this.onWebSocketMessageReceived, this), this);
    },

    onWebSocketOpen: function() {
        this._wsIsOpen = true;

        this.fireEvent('wsopen', this);
    },

    updateSymbol: function(symbol, oldSymbol) {
        this.unsubscribe(oldSymbol);
        this.subscribe(symbol);
    },

    subscribe: function(symbol) {
        var doSubscribe = function() {
            if (!Ext.isEmpty(symbol)) {
                // this.socket.send(JSON.stringify({'type': 'subscribe', 'symbol': symbol}));

                this.streamDummyData();
            }
        }
        if (this._wsIsOpen) {
            doSubscribe();
        } else {
            this.on('wsopen', doSubscribe, this);
        }
    },

    unsubscribe: function(symbol) {
        if (this._wsIsOpen) {
            this.socket.send(JSON.stringify({'type': 'unsubscribe', 'symbol': symbol}));
        }
    },

    onWebSocketMessageReceived: function (event) {
        this._raw = this._raw || [];

        this._raw.push(event);


        var transformedData = this.webSocketRecordTransform(Ext.decode(event.data).data);

        console.log('WS Data Received: ', transformedData);

        this.add(transformedData);
    },

    streamDummyData: function() {
        var data = [{"data":[{"c":["1","12"],"p":143.5921,"s":"AAPL","t":1657133956097,"v":5},{"c":["1"],"p":143.5901,"s":"AAPL","t":1657133956140,"v":100},{"c":["1","8"],"p":143.6,"s":"AAPL","t":1657133956320,"v":100},{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133956369,"v":10},{"c":["1","8"],"p":143.6,"s":"AAPL","t":1657133956391,"v":100},{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133956392,"v":25},{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133956526,"v":10},{"c":["1","12"],"p":143.6088,"s":"AAPL","t":1657133956527,"v":1},{"c":["1"],"p":143.615,"s":"AAPL","t":1657133956987,"v":100},{"c":["1","12"],"p":143.6094,"s":"AAPL","t":1657133956717,"v":5}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.6188,"s":"AAPL","t":1657133957039,"v":1},{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133957375,"v":79},{"c":["1","12"],"p":143.6099,"s":"AAPL","t":1657133957580,"v":5},{"c":["1"],"p":143.6099,"s":"AAPL","t":1657133957909,"v":100}],"type":"trade"},{"data":[{"c":["1"],"p":143.605,"s":"AAPL","t":1657133958113,"v":100},{"c":["1","12"],"p":143.6088,"s":"AAPL","t":1657133958301,"v":1},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133958370,"v":100},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133958371,"v":100},{"c":["1","12"],"p":143.6037,"s":"AAPL","t":1657133958485,"v":1},{"c":["1","8","12"],"p":143.61,"s":"AAPL","t":1657133958672,"v":13},{"c":["1","8","12"],"p":143.61,"s":"AAPL","t":1657133958672,"v":12},{"c":["1","8","12"],"p":143.61,"s":"AAPL","t":1657133958672,"v":75},{"c":["1","8"],"p":143.61,"s":"AAPL","t":1657133958672,"v":100},{"c":["1"],"p":143.61,"s":"AAPL","t":1657133958672,"v":100}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.61,"s":"AAPL","t":1657133958988,"v":1}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.61,"s":"AAPL","t":1657133959174,"v":49},{"c":["1","12"],"p":143.61,"s":"AAPL","t":1657133959175,"v":51},{"c":["1"],"p":143.6001,"s":"AAPL","t":1657133959188,"v":500},{"c":["1","12"],"p":143.61,"s":"AAPL","t":1657133959232,"v":5},{"c":["1","12"],"p":143.61,"s":"AAPL","t":1657133959244,"v":25},{"c":["1","12"],"p":143.601,"s":"AAPL","t":1657133959250,"v":18},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959249,"v":200},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959250,"v":100},{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133959249,"v":50},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959250,"v":306}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133959258,"v":50},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959259,"v":100},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959259,"v":100},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959259,"v":400},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959259,"v":100},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959259,"v":100},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959252,"v":775},{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133959259,"v":76},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959260,"v":100},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959260,"v":100}],"type":"trade"},{"data":[{"c":["1"],"p":143.6,"s":"AAPL","t":1657133959260,"v":400},{"c":["1"],"p":143.595,"s":"AAPL","t":1657133959434,"v":100},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133959514,"v":99},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133959558,"v":202},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133959558,"v":41},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133959558,"v":2},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133959558,"v":656},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133959559,"v":73},{"c":["1","8"],"p":143.58,"s":"AAPL","t":1657133959745,"v":100},{"c":["1","8","12"],"p":143.58,"s":"AAPL","t":1657133960085,"v":3}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.5802,"s":"AAPL","t":1657133960096,"v":7}],"type":"trade"},{"data":[{"c":["8"],"p":143.62,"s":"AAPL","t":1657133919987,"v":100},{"c":["1","12"],"p":143.5847,"s":"AAPL","t":1657133960879,"v":25},{"c":["1","12"],"p":143.58,"s":"AAPL","t":1657133960970,"v":10},{"c":["1"],"p":143.585,"s":"AAPL","t":1657133961007,"v":100},{"c":["1"],"p":143.5884,"s":"AAPL","t":1657133961090,"v":500}],"type":"trade"},{"data":[{"c":["1"],"p":143.585,"s":"AAPL","t":1657133961138,"v":100},{"c":["1"],"p":143.58,"s":"AAPL","t":1657133961210,"v":1000},{"c":["1","12"],"p":143.585,"s":"AAPL","t":1657133961237,"v":2},{"c":["1","12"],"p":143.5809,"s":"AAPL","t":1657133961527,"v":44},{"c":["1","12"],"p":143.585,"s":"AAPL","t":1657133961369,"v":1},{"c":["1"],"p":143.5847,"s":"AAPL","t":1657133961673,"v":100},{"c":["1","12"],"p":143.5847,"s":"AAPL","t":1657133961898,"v":3},{"c":["1"],"p":143.585,"s":"AAPL","t":1657133962120,"v":500}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.5872,"s":"AAPL","t":1657133962271,"v":16},{"c":["1"],"p":143.58,"s":"AAPL","t":1657133962475,"v":100},{"c":["1"],"p":143.585,"s":"AAPL","t":1657133962645,"v":200},{"c":["1"],"p":143.5842,"s":"AAPL","t":1657133962700,"v":125},{"c":["1","12"],"p":143.5858,"s":"AAPL","t":1657133962711,"v":5},{"c":["1","12"],"p":143.585,"s":"AAPL","t":1657133962862,"v":5}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.5813,"s":"AAPL","t":1657133963304,"v":5},{"c":["1","12"],"p":143.59,"s":"AAPL","t":1657133963441,"v":3},{"c":["1","12"],"p":143.5813,"s":"AAPL","t":1657133963520,"v":47},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133963573,"v":100},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133963573,"v":100},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133963572,"v":24},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133963572,"v":76},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133963572,"v":100},{"c":["1","8"],"p":143.585,"s":"AAPL","t":1657133963573,"v":100},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133963573,"v":40}],"type":"trade"},{"data":[{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133963573,"v":59},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133963573,"v":1},{"c":["8"],"p":143.57,"s":"AAPL","t":1657133924342,"v":100}],"type":"trade"},{"data":[{"c":["1"],"p":143.595,"s":"AAPL","t":1657133964216,"v":100},{"c":["1"],"p":143.59,"s":"AAPL","t":1657133964319,"v":100},{"c":["1"],"p":143.6,"s":"AAPL","t":1657133964385,"v":100},{"c":["1"],"p":143.5944,"s":"AAPL","t":1657133965033,"v":100},{"c":["1"],"p":143.595,"s":"AAPL","t":1657133965060,"v":750}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.5988,"s":"AAPL","t":1657133965814,"v":1},{"c":["1","12"],"p":143.5902,"s":"AAPL","t":1657133965882,"v":75},{"c":["1"],"p":143.595,"s":"AAPL","t":1657133965893,"v":600},{"c":["1","12"],"p":143.595,"s":"AAPL","t":1657133965898,"v":50},{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133966025,"v":10},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133966088,"v":63},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133966089,"v":37},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133966089,"v":79},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133966089,"v":81},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133966089,"v":237}],"type":"trade"},{"data":[{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133966089,"v":103},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133966089,"v":14},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133966089,"v":300},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133966089,"v":100},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133966089,"v":186},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133966088,"v":200},{"c":["1","8"],"p":143.58,"s":"AAPL","t":1657133966098,"v":200},{"c":["1","8","12"],"p":143.58,"s":"AAPL","t":1657133966098,"v":7},{"c":["1","8"],"p":143.58,"s":"AAPL","t":1657133966098,"v":100}],"type":"trade"},{"data":[{"c":["1"],"p":143.59,"s":"AAPL","t":1657133966540,"v":100},{"c":["1"],"p":143.58,"s":"AAPL","t":1657133966542,"v":100},{"c":["1","8"],"p":143.59,"s":"AAPL","t":1657133966683,"v":100},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133966684,"v":1},{"c":["1"],"p":143.595,"s":"AAPL","t":1657133965997,"v":100},{"c":["1","12"],"p":143.59,"s":"AAPL","t":1657133967154,"v":10},{"c":["1","12"],"p":143.59,"s":"AAPL","t":1657133967113,"v":10},{"c":["1","12"],"p":143.59,"s":"AAPL","t":1657133967238,"v":89}],"type":"trade"},{"data":[{"c":["1"],"p":143.5892,"s":"AAPL","t":1657133967402,"v":500},{"c":["1"],"p":143.5839,"s":"AAPL","t":1657133967597,"v":400},{"c":["1","12"],"p":143.5811,"s":"AAPL","t":1657133967952,"v":1}],"type":"trade"},{"data":[{"c":["1"],"p":143.585,"s":"AAPL","t":1657133968531,"v":100},{"c":["1","12"],"p":143.5837,"s":"AAPL","t":1657133968553,"v":1},{"c":["1","12"],"p":143.585,"s":"AAPL","t":1657133968616,"v":50},{"c":["1","12"],"p":143.5888,"s":"AAPL","t":1657133968827,"v":1},{"c":["1","12"],"p":143.585,"s":"AAPL","t":1657133968850,"v":1},{"c":["1"],"p":143.5801,"s":"AAPL","t":1657133969017,"v":951},{"c":["1"],"p":143.59,"s":"AAPL","t":1657133969017,"v":1049},{"c":["1"],"p":143.58,"s":"AAPL","t":1657133969016,"v":951},{"c":["1"],"p":143.59,"s":"AAPL","t":1657133969061,"v":100},{"c":["1"],"p":143.59,"s":"AAPL","t":1657133969061,"v":100}],"type":"trade"},{"data":[{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133969061,"v":52},{"c":["1","8","12"],"p":143.59,"s":"AAPL","t":1657133969061,"v":48},{"c":["1"],"p":143.59,"s":"AAPL","t":1657133969061,"v":100},{"c":["1"],"p":143.595,"s":"AAPL","t":1657133969067,"v":348},{"c":["1"],"p":143.59,"s":"AAPL","t":1657133969178,"v":100}],"type":"trade"},{"data":[{"c":["1","12"],"p":143.59,"s":"AAPL","t":1657133969337,"v":1},{"c":["1"],"p":143.595,"s":"AAPL","t":1657133969456,"v":1000},{"c":["1","12"],"p":143.59,"s":"AAPL","t":1657133969592,"v":10},{"c":["1","12"],"p":143.6,"s":"AAPL","t":1657133969647,"v":50},{"c":["1"],"p":143.5907,"s":"AAPL","t":1657133969755,"v":400},{"c":["1","12"],"p":143.59,"s":"AAPL","t":1657133968853,"v":1},{"c":["1"],"p":143.5901,"s":"AAPL","t":1657133970097,"v":102},{"c":["1","12"],"p":143.5911,"s":"AAPL","t":1657133970107,"v":1},{"c":["1","12"],"p":143.5988,"s":"AAPL","t":1657133970099,"v":1},{"c":["1"],"p":143.59,"s":"AAPL","t":1657133970171,"v":100}],"type":"trade"}];
        var i = 0;

        setInterval(() => {
            if (!data[i]) {
                i = 0;
            }
            var transformedData = this.webSocketRecordTransform(data[i].data);

            console.log('WS Data Received: ', transformedData);
    
            this.add(transformedData);

            i += 1;
        }, 1000);
    }
})